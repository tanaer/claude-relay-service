name: CI Pipeline (Optimized with Pre-commit Hooks)

on:
  push:
    branches: [main, devlocal]
  pull_request:
    branches: [main]

jobs:
  # åªåš pre-commit hooks ä¸èƒ½åšçš„æ£€æŸ¥
  extended-quality:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install backend dependencies
        run: npm install

      - name: Install frontend dependencies
        run: cd web/admin-spa && npm install

      # âœ… ç¼–è¯‘æ£€æŸ¥ - pre-commit hooks ä¸é€‚åˆåš
      - name: Backend compilation check
        run: |
          echo "ğŸ” Checking backend compilation..."
          node -c src/app.js || exit 1
          echo "âœ… Backend compilation check passed"

      - name: Frontend build check  
        run: |
          echo "ğŸ—ï¸ Building frontend for production..."
          cd web/admin-spa && npm run build
          echo "âœ… Frontend build succeeded"

      # âœ… æµ‹è¯•è¿è¡Œ - pre-commit hooks ä¸é€‚åˆåš
      - name: Run backend tests
        run: |
          if [ -f "package.json" ] && ([ -d "test" ] || [ -d "tests" ] || [ -d "__tests__" ]); then
            echo "ğŸ§ª Running backend tests..."
            npm test
          else
            echo "ğŸ“ No backend tests found"
          fi
        continue-on-error: true

      - name: Run frontend tests
        run: |
          cd web/admin-spa
          if [ -f "package.json" ] && ([ -d "test" ] || [ -d "tests" ] || [ -d "__tests__" ]); then
            echo "ğŸ§ª Running frontend tests..."
            npm test
          else
            echo "ğŸ“ No frontend tests found"
          fi
        continue-on-error: true

      # âœ… å®‰å…¨æ£€æŸ¥ - pre-commit hooks ä¸é€‚åˆåš
      - name: Security audit (Backend)
        run: |
          echo "ğŸ”’ Running security audit on backend..."
          npm audit --audit-level high --production
        continue-on-error: true

      - name: Security audit (Frontend)
        run: |
          echo "ğŸ”’ Running security audit on frontend..."
          cd web/admin-spa && npm audit --audit-level high --production
        continue-on-error: true

      # âœ… Bundle åˆ†æ - pre-commit hooks ä¸é€‚åˆåš
      - name: Bundle size analysis
        run: |
          echo "ğŸ“Š Analyzing frontend bundle size..."
          cd web/admin-spa
          npm run build
          BUNDLE_SIZE=$(du -sh dist/ | cut -f1)
          echo "ğŸ“¦ Bundle size: $BUNDLE_SIZE"
          
          # æ£€æŸ¥å¤§å°æ˜¯å¦è¶…è¿‡é™åˆ¶ (ä¾‹å¦‚ 10MB)
          SIZE_BYTES=$(du -sb dist/ | cut -f1)
          MAX_SIZE=$((10 * 1024 * 1024)) # 10MB
          
          if [ $SIZE_BYTES -gt $MAX_SIZE ]; then
            echo "âš ï¸ Bundle size ($BUNDLE_SIZE) exceeds 10MB limit"
          else
            echo "âœ… Bundle size is within acceptable limits"
          fi

      # âœ… æ•æ„Ÿæ•°æ®æ£€æŸ¥ - pre-commit hooks ä¸é€‚åˆåš
      - name: Check for sensitive data
        run: |
          echo "ğŸ•µï¸ Checking for potential sensitive data leaks..."
          
          SENSITIVE_PATTERNS="password.*=|secret.*=|token.*=|key.*=|api_key.*=|private.*key"
          
          if grep -r -E "$SENSITIVE_PATTERNS" src/ web/admin-spa/src/ \
               --include="*.js" --include="*.vue" --include="*.ts" \
               | grep -v "placeholder\|example\|test\|TODO\|FIXME" \
               | head -10; then
            echo "âš ï¸ Potential sensitive data found - please review above matches"
            echo "Note: This might be false positive - verify manually"
          else
            echo "âœ… No obvious sensitive data leaks detected"
          fi
        continue-on-error: true

      - name: Summary
        run: |
          echo "ğŸ‰ CI Pipeline completed successfully!"
          echo ""
          echo "ğŸ“‹ Responsibility Matrix:"
          echo "â”œâ”€â”€ ğŸ  Pre-commit Hooks (Local, Fast):"
          echo "â”‚   â”œâ”€â”€ âœ… Code formatting (Prettier)"
          echo "â”‚   â”œâ”€â”€ âœ… Linting (ESLint)"  
          echo "â”‚   â””â”€â”€ âœ… Style consistency"
          echo "â””â”€â”€ ğŸŒ GitHub Actions (CI, Comprehensive):"
          echo "    â”œâ”€â”€ âœ… Compilation verification"
          echo "    â”œâ”€â”€ âœ… Test execution"
          echo "    â”œâ”€â”€ âœ… Security auditing"
          echo "    â”œâ”€â”€ âœ… Bundle size analysis"
          echo "    â””â”€â”€ âœ… Sensitive data detection"
          echo ""
          echo "ğŸš€ No duplicate work, maximum efficiency!"