#!/usr/bin/env sh

echo "Running pre-commit checks on staged files..."

# 确保在正确的目录
if [ ! -f "package.json" ]; then
    echo "Error: Not in project root directory!"
    exit 1
fi

# 获取已暂存的文件列表
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo "No staged files to check."
    exit 0
fi

echo "Checking staged files: $(echo $STAGED_FILES | wc -w) files"

# 分离后端和前端文件
BACKEND_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js)$' | grep -v 'web/admin-spa/' | tr '\n' ' ')
FRONTEND_FILES=$(echo "$STAGED_FILES" | grep 'web/admin-spa/' | grep -E '\.(vue|js|ts|css|scss)$' | tr '\n' ' ')

# 检查后端文件
if [ -n "$BACKEND_FILES" ]; then
    echo "Formatting backend files..."
    npx prettier --write $BACKEND_FILES
    
    echo "Checking backend files..."
    npx eslint $BACKEND_FILES --fix
    if [ $? -ne 0 ]; then
        echo "Backend lint issues detected!"
        exit 1
    fi
    
    # 重新添加格式化后的文件到暂存区
    git add $BACKEND_FILES
fi

# 检查前端文件
if [ -n "$FRONTEND_FILES" ]; then
    echo "Formatting frontend files..."
    cd web/admin-spa
    
    # 转换为相对于 web/admin-spa 的路径
    FRONTEND_REL_FILES=$(echo "$FRONTEND_FILES" | sed 's|web/admin-spa/||g')
    
    npx prettier --write $FRONTEND_REL_FILES
    npx eslint $FRONTEND_REL_FILES --fix
    if [ $? -ne 0 ]; then
        echo "Frontend lint issues detected!"
        cd ../..
        exit 1
    fi
    
    cd ../..
    # 重新添加格式化后的文件到暂存区
    git add $FRONTEND_FILES
fi

echo "All pre-commit checks passed!"