<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Claude Code - AIç¼–ç¨‹åŠ©æ‰‹</title>
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --background-light: #f8fafc;
            --background-dark: #0f172a;
            --text-light: #1e293b;
            --text-dark: #f1f5f9;
            --border-light: #e2e8f0;
            --border-dark: #334155;
            --sidebar-width: 280px;
            --header-height: 60px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--background-light);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
        }

        body.dark {
            background: var(--background-dark);
            color: var(--text-dark);
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        body.dark .sidebar {
            background: #1e293b;
            border-color: var(--border-dark);
        }

        .sidebar-header {
            height: var(--header-height);
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-light);
        }

        body.dark .sidebar-header {
            border-color: var(--border-dark);
        }

        .logo {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .new-chat-btn {
            padding: 8px 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .new-chat-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            group: hover;
        }

        .chat-item:hover {
            background: var(--background-light);
        }

        body.dark .chat-item:hover {
            background: #334155;
        }

        .chat-item.active {
            background: var(--primary-color);
            color: white;
        }

        .chat-title {
            font-size: 14px;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }

        .chat-actions {
            display: none;
            gap: 4px;
        }

        .chat-item:hover .chat-actions {
            display: flex;
        }

        .chat-action-btn {
            padding: 4px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            color: inherit;
            opacity: 0.7;
        }

        .chat-action-btn:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        body.dark .main-content {
            background: #0f172a;
        }

        /* å¤´éƒ¨å·¥å…·æ  */
        .toolbar {
            height: var(--header-height);
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: between;
            border-bottom: 1px solid var(--border-light);
            gap: 16px;
        }

        body.dark .toolbar {
            border-color: var(--border-dark);
        }

        .model-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .model-select {
            padding: 6px 12px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            background: white;
            color: var(--text-light);
            font-size: 14px;
            cursor: pointer;
        }

        body.dark .model-select {
            background: #1e293b;
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        .toolbar-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: auto;
        }

        .tool-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        body.dark .tool-btn {
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        .tool-btn:hover {
            background: var(--background-light);
        }

        body.dark .tool-btn:hover {
            background: #334155;
        }

        .theme-toggle {
            background: var(--primary-color);
            color: white;
            border: none;
        }

        /* æ¶ˆæ¯åŒºåŸŸ */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: var(--primary-color);
            color: white;
        }

        .message.assistant .message-avatar {
            background: var(--secondary-color);
            color: white;
        }

        .message.system .message-avatar {
            background: #ef4444;
            color: white;
        }

        .message-content {
            flex: 1;
            padding: 12px 16px;
            border-radius: 12px;
            position: relative;
        }

        .message.user .message-content {
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: var(--background-light);
            border: 1px solid var(--border-light);
            border-bottom-left-radius: 4px;
        }

        body.dark .message.assistant .message-content {
            background: #1e293b;
            border-color: var(--border-dark);
        }

        .message.system .message-content {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            text-align: center;
        }

        body.dark .message.system .message-content {
            background: #431e1e;
            border-color: #7f1d1d;
            color: #f87171;
        }

        .message-text {
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .message-action-btn {
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            background: white;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
        }

        body.dark .message-action-btn {
            background: #334155;
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        .message-action-btn:hover {
            background: var(--background-light);
        }

        body.dark .message-action-btn:hover {
            background: #475569;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            padding: 20px;
            border-top: 1px solid var(--border-light);
        }

        body.dark .input-area {
            border-color: var(--border-dark);
        }

        .input-container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: white;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 12px;
            transition: all 0.2s;
        }

        body.dark .input-wrapper {
            background: #1e293b;
            border-color: var(--border-dark);
        }

        .input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .message-input {
            flex: 1;
            border: none;
            outline: none;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.5;
            max-height: 200px;
            min-height: 20px;
            background: transparent;
            color: inherit;
        }

        .send-btn {
            padding: 8px 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .send-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .send-btn:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* æ‰“å­—æŒ‡ç¤ºå™¨ */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #64748b;
            font-size: 14px;
            padding: 16px 0;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #64748b;
            border-radius: 50%;
            animation: typing 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* çŠ¶æ€æ  */
        .status-bar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 16px;
            background: #1e293b;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            transition: all 0.3s;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-connected { background: #10b981; }
        .status-connecting { background: #f59e0b; }
        .status-error { background: #ef4444; }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                width: 100%;
            }

            .toolbar {
                padding: 0 12px;
            }

            .messages-area {
                padding: 12px;
            }

            .input-area {
                padding: 12px;
            }

            .message {
                max-width: 100%;
            }
        }

        /* ä»£ç å—æ ·å¼ */
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.4;
            margin: 8px 0;
        }

        body.dark .code-block {
            background: #0f172a;
            border: 1px solid var(--border-dark);
        }

        /* å·¥å…·æç¤º */
        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">ğŸ¤– Claude Code</div>
                <button class="new-chat-btn" onclick="startNewChat()">
                    + æ–°å¯¹è¯
                </button>
            </div>
            <div class="chat-list" id="chatList">
                <div class="chat-item active" data-chat-id="default">
                    <span class="chat-title">æ–°çš„å¯¹è¯</span>
                    <div class="chat-actions">
                        <button class="chat-action-btn" onclick="renameChat('default')" data-tooltip="é‡å‘½å">
                            âœï¸
                        </button>
                        <button class="chat-action-btn" onclick="deleteChat('default')" data-tooltip="åˆ é™¤">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹ -->
        <div class="main-content">
            <!-- å·¥å…·æ  -->
            <div class="toolbar">
                <button class="tool-btn" onclick="toggleSidebar()" id="sidebarToggle">
                    â˜°
                </button>
                
                <div class="model-selector">
                    <label for="modelSelect">æ¨¡å‹:</label>
                    <select class="model-select" id="modelSelect">
                        <option value="claude-opus-4-1-20250805">Claude Opus 4.1</option>
                        <option value="claude-sonnet-4-20250514">Claude Sonnet 4</option>
                    </select>
                </div>

                <div class="toolbar-actions">
                    <button class="tool-btn tooltip" onclick="exportChat()" data-tooltip="å¯¼å‡ºå¯¹è¯">
                        ğŸ“„ å¯¼å‡º
                    </button>
                    <button class="tool-btn tooltip" onclick="clearChat()" data-tooltip="æ¸…ç©ºå¯¹è¯">
                        ğŸ—‘ï¸ æ¸…ç©º
                    </button>
                    <button class="tool-btn tooltip" onclick="showSettings()" data-tooltip="è®¾ç½®">
                        âš™ï¸ è®¾ç½®
                    </button>
                    <button class="tool-btn theme-toggle tooltip" onclick="toggleTheme()" data-tooltip="åˆ‡æ¢ä¸»é¢˜">
                        ğŸŒ™
                    </button>
                </div>
            </div>

            <!-- æ¶ˆæ¯åŒºåŸŸ -->
            <div class="messages-area" id="messagesArea">
                <div class="message assistant">
                    <div class="message-avatar">AI</div>
                    <div class="message-content">
                        <div class="message-text">ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯åŸºäº Claude çš„ AI ç¼–ç¨‹åŠ©æ‰‹ã€‚

æˆ‘å¯ä»¥å¸®åŠ©ä½ ï¼š
â€¢ ğŸ”§ ç¼–å†™å’Œè°ƒè¯•ä»£ç 
â€¢ ğŸ“š è§£é‡Šå¤æ‚æ¦‚å¿µ
â€¢ ğŸš€ ç³»ç»Ÿæ¶æ„è®¾è®¡
â€¢ ğŸ“ ä»£ç å®¡æŸ¥å’Œä¼˜åŒ–
â€¢ ğŸ¤” ç®—æ³•å’Œæ•°æ®ç»“æ„

æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ</div>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="input-area">
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯... (Shift+Enter æ¢è¡Œ)"
                            rows="1"
                        ></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            <span id="sendBtnText">å‘é€</span>
                            <span id="sendBtnIcon">ğŸ“¤</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- çŠ¶æ€æ  -->
    <div class="status-bar" id="statusBar">
        <div class="status-dot status-connecting" id="statusDot"></div>
        <span id="statusText">æ­£åœ¨è¿æ¥...</span>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let currentChatId = 'default'
        let chats = {
            'default': {
                id: 'default',
                title: 'æ–°çš„å¯¹è¯',
                messages: [],
                createdAt: new Date().toISOString()
            }
        }
        let isStreaming = false
        let currentStreamMessage = null
        let claudeAPI = null

        // Claude API å®¢æˆ·ç«¯ç±»
        class ClaudeAPIClient {
            constructor(apiKey, baseUrl = '') {
                this.apiKey = apiKey
                this.baseUrl = baseUrl
            }

            async sendMessage(messages, options = {}) {
                const {
                    model = 'claude-opus-4-1-20250805',
                    stream = true,
                    maxTokens = 4000,
                    temperature = 0.7
                } = options

                try {
                    const response = await fetch(`${this.baseUrl}/openai/claude/v1/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model,
                            messages,
                            stream,
                            max_tokens: maxTokens,
                            temperature
                        })
                    })

                    if (!response.ok) {
                        const errorText = await response.text()
                        console.error('APIé”™è¯¯å“åº”:', errorText)
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`)
                    }

                    if (stream) {
                        return this.handleStreamResponse(response)
                    } else {
                        const data = await response.json()
                        return data.choices[0].message.content
                    }
                } catch (error) {
                    console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error)
                    throw error
                }
            }

            async handleStreamResponse(response) {
                const reader = response.body.getReader()
                const decoder = new TextDecoder()
                let fullResponse = ''

                return new Promise((resolve, reject) => {
                    const processStream = async () => {
                        try {
                            while (true) {
                                const { done, value } = await reader.read()
                                if (done) break

                                const chunk = decoder.decode(value, { stream: true })
                                const lines = chunk.split('\n')

                                for (const line of lines) {
                                    if (line.startsWith('data: ')) {
                                        const data = line.slice(6).trim()
                                        if (data === '[DONE]') {
                                            resolve(fullResponse)
                                            return
                                        }

                                        try {
                                            const parsed = JSON.parse(data)
                                            const content = parsed.choices[0]?.delta?.content
                                            if (content) {
                                                fullResponse += content
                                                if (this.onStreamChunk) {
                                                    this.onStreamChunk(content, fullResponse)
                                                }
                                            }
                                        } catch (e) {
                                            // å¿½ç•¥JSONè§£æé”™è¯¯
                                            console.log('JSONè§£æé”™è¯¯:', data)
                                        }
                                    }
                                }
                            }
                            resolve(fullResponse)
                        } catch (error) {
                            reject(error)
                        }
                    }

                    processStream()
                })
            }

            async getModels() {
                try {
                    const response = await fetch(`${this.baseUrl}/openai/claude/v1/models`, {
                        headers: {
                            'Authorization': `Bearer ${this.apiKey}`
                        }
                    })

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`)
                    }

                    const data = await response.json()
                    return data.data
                } catch (error) {
                    console.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error)
                    throw error
                }
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', async function() {
            // ä»URLå‚æ•°æˆ–localStorageè·å–API Key
            const urlParams = new URLSearchParams(window.location.search)
            let apiKey = urlParams.get('apiKey') || localStorage.getItem('claude_api_key')

            if (!apiKey) {
                apiKey = prompt('è¯·è¾“å…¥ä½ çš„API Key (cr_å¼€å¤´):')
                if (!apiKey) {
                    updateStatus('error', 'éœ€è¦API Keyæ‰èƒ½ä½¿ç”¨')
                    return
                }
                localStorage.setItem('claude_api_key', apiKey)
            }

            // åˆå§‹åŒ–Claude APIå®¢æˆ·ç«¯
            claudeAPI = new ClaudeAPIClient(apiKey)
            
            // è®¾ç½®æµå¼å›è°ƒ
            claudeAPI.onStreamChunk = (chunk, fullResponse) => {
                if (currentStreamMessage) {
                    const messageText = currentStreamMessage.querySelector('.message-text')
                    if (messageText) {
                        messageText.textContent = fullResponse
                        scrollToBottom()
                    }
                }
            }

            // æµ‹è¯•è¿æ¥å¹¶åŠ è½½æ¨¡å‹
            try {
                updateStatus('connecting', 'æ­£åœ¨è¿æ¥åˆ°Claude API...')
                const models = await claudeAPI.getModels()
                updateStatus('connected', `å·²è¿æ¥ - ${models.length}ä¸ªå¯ç”¨æ¨¡å‹`)
                
                // æ›´æ–°æ¨¡å‹é€‰æ‹©å™¨
                const modelSelect = document.getElementById('modelSelect')
                modelSelect.innerHTML = ''
                models.forEach(model => {
                    const option = document.createElement('option')
                    option.value = model.id
                    option.textContent = model.id
                    modelSelect.appendChild(option)
                })
            } catch (error) {
                updateStatus('error', `è¿æ¥å¤±è´¥: ${error.message}`)
                console.error('åˆå§‹åŒ–å¤±è´¥:', error)
            }

            // åŠ è½½ä¿å­˜çš„å¯¹è¯
            loadChats()

            // è®¾ç½®è¾“å…¥æ¡†äº‹ä»¶
            setupInputEvents()

            // åŠ è½½ä¸»é¢˜è®¾ç½®
            loadTheme()
        })

        // è®¾ç½®è¾“å…¥æ¡†äº‹ä»¶
        function setupInputEvents() {
            const messageInput = document.getElementById('messageInput')
            
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault()
                    sendMessage()
                }
            })

            messageInput.addEventListener('input', function() {
                this.style.height = 'auto'
                this.style.height = Math.min(this.scrollHeight, 200) + 'px'
            })
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            if (isStreaming || !claudeAPI) return

            const messageInput = document.getElementById('messageInput')
            const sendBtn = document.getElementById('sendBtn')
            const message = messageInput.value.trim()

            if (!message) return

            // ç¦ç”¨è¾“å…¥
            isStreaming = true
            messageInput.disabled = true
            sendBtn.disabled = true
            updateSendButton(true)

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage('user', message)
            messageInput.value = ''
            messageInput.style.height = 'auto'

            // æ·»åŠ æ­£åœ¨è¾“å…¥çš„æ¶ˆæ¯
            currentStreamMessage = addMessage('assistant', '', true)

            try {
                const currentChat = chats[currentChatId]
                const messages = [...currentChat.messages, { role: 'user', content: message }]
                const modelSelect = document.getElementById('modelSelect')
                
                updateStatus('connecting', 'æ­£åœ¨å‘é€æ¶ˆæ¯...')

                const response = await claudeAPI.sendMessage(messages, {
                    model: modelSelect.value,
                    stream: true
                })

                // æ›´æ–°æ¶ˆæ¯å†å²
                currentChat.messages.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content: response }
                )

                // æ›´æ–°èŠå¤©æ ‡é¢˜ï¼ˆå¦‚æœæ˜¯æ–°å¯¹è¯ï¼‰
                if (currentChat.messages.length === 2 && currentChat.title === 'æ–°çš„å¯¹è¯') {
                    currentChat.title = message.substring(0, 30) + (message.length > 30 ? '...' : '')
                    updateChatList()
                }

                saveChats()
                updateStatus('connected', 'æ¶ˆæ¯å‘é€å®Œæˆ')

            } catch (error) {
                console.error('å‘é€å¤±è´¥:', error)
                updateStatus('error', `å‘é€å¤±è´¥: ${error.message}`)
                
                // ç§»é™¤æµå¼æ¶ˆæ¯
                if (currentStreamMessage) {
                    currentStreamMessage.remove()
                }
                
                // æ·»åŠ é”™è¯¯æ¶ˆæ¯
                addMessage('system', `å‘é€å¤±è´¥: ${error.message}`)
            } finally {
                // æ¢å¤è¾“å…¥
                isStreaming = false
                messageInput.disabled = false
                sendBtn.disabled = false
                updateSendButton(false)
                messageInput.focus()
                currentStreamMessage = null
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addMessage(role, content, isStreaming = false) {
            const messagesArea = document.getElementById('messagesArea')
            
            const messageDiv = document.createElement('div')
            messageDiv.className = `message ${role}`

            let avatar = role === 'user' ? 'ğŸ‘¤' : role === 'assistant' ? 'ğŸ¤–' : 'âš ï¸'
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-text">${formatMessage(content)}</div>
                    ${!isStreaming && role !== 'system' ? `
                        <div class="message-actions">
                            <button class="message-action-btn" onclick="copyMessage(this)">å¤åˆ¶</button>
                            ${role === 'assistant' ? '<button class="message-action-btn" onclick="regenerateMessage(this)">é‡æ–°ç”Ÿæˆ</button>' : ''}
                        </div>
                    ` : ''}
                </div>
            `

            messagesArea.appendChild(messageDiv)
            scrollToBottom()
            
            return messageDiv
        }

        // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹
        function formatMessage(content) {
            if (!content) return ''
            
            // å¤„ç†ä»£ç å—
            content = content.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
                return `<div class="code-block"><pre><code>${escapeHtml(code.trim())}</code></pre></div>`
            })
            
            // å¤„ç†å†…è”ä»£ç 
            content = content.replace(/`([^`]+)`/g, '<code>$1</code>')
            
            return content.replace(/\n/g, '<br>')
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div')
            div.textContent = text
            return div.innerHTML
        }

        // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
        function updateSendButton(loading) {
            const sendBtnText = document.getElementById('sendBtnText')
            const sendBtnIcon = document.getElementById('sendBtnIcon')
            
            if (loading) {
                sendBtnText.textContent = 'å‘é€ä¸­...'
                sendBtnIcon.innerHTML = '<div class="loading"></div>'
            } else {
                sendBtnText.textContent = 'å‘é€'
                sendBtnIcon.textContent = 'ğŸ“¤'
            }
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(status, message) {
            const statusDot = document.getElementById('statusDot')
            const statusText = document.getElementById('statusText')
            
            statusDot.className = `status-dot status-${status}`
            statusText.textContent = message
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            const messagesArea = document.getElementById('messagesArea')
            messagesArea.scrollTop = messagesArea.scrollHeight
        }

        // å¼€å§‹æ–°å¯¹è¯
        function startNewChat() {
            const chatId = 'chat_' + Date.now()
            chats[chatId] = {
                id: chatId,
                title: 'æ–°çš„å¯¹è¯',
                messages: [],
                createdAt: new Date().toISOString()
            }
            
            switchToChat(chatId)
            updateChatList()
            saveChats()
        }

        // åˆ‡æ¢åˆ°æŒ‡å®šå¯¹è¯
        function switchToChat(chatId) {
            currentChatId = chatId
            loadMessages()
            updateChatList()
        }

        // åŠ è½½æ¶ˆæ¯
        function loadMessages() {
            const messagesArea = document.getElementById('messagesArea')
            messagesArea.innerHTML = ''
            
            // æ·»åŠ é»˜è®¤æ¬¢è¿æ¶ˆæ¯
            if (chats[currentChatId].messages.length === 0) {
                addMessage('assistant', `ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯åŸºäº Claude çš„ AI ç¼–ç¨‹åŠ©æ‰‹ã€‚

æˆ‘å¯ä»¥å¸®åŠ©ä½ ï¼š
â€¢ ğŸ”§ ç¼–å†™å’Œè°ƒè¯•ä»£ç 
â€¢ ğŸ“š è§£é‡Šå¤æ‚æ¦‚å¿µ  
â€¢ ğŸš€ ç³»ç»Ÿæ¶æ„è®¾è®¡
â€¢ ğŸ“ ä»£ç å®¡æŸ¥å’Œä¼˜åŒ–
â€¢ ğŸ¤” ç®—æ³•å’Œæ•°æ®ç»“æ„

æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ`)
            } else {
                // åŠ è½½å†å²æ¶ˆæ¯
                chats[currentChatId].messages.forEach(msg => {
                    addMessage(msg.role, msg.content)
                })
            }
        }

        // æ›´æ–°å¯¹è¯åˆ—è¡¨
        function updateChatList() {
            const chatList = document.getElementById('chatList')
            chatList.innerHTML = ''
            
            Object.values(chats).reverse().forEach(chat => {
                const chatItem = document.createElement('div')
                chatItem.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`
                chatItem.setAttribute('data-chat-id', chat.id)
                chatItem.onclick = () => switchToChat(chat.id)
                
                chatItem.innerHTML = `
                    <span class="chat-title">${chat.title}</span>
                    <div class="chat-actions">
                        <button class="chat-action-btn tooltip" onclick="event.stopPropagation(); renameChat('${chat.id}')" data-tooltip="é‡å‘½å">
                            âœï¸
                        </button>
                        <button class="chat-action-btn tooltip" onclick="event.stopPropagation(); deleteChat('${chat.id}')" data-tooltip="åˆ é™¤">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                `
                
                chatList.appendChild(chatItem)
            })
        }

        // é‡å‘½åå¯¹è¯
        function renameChat(chatId) {
            const newTitle = prompt('è¯·è¾“å…¥æ–°çš„å¯¹è¯æ ‡é¢˜:', chats[chatId].title)
            if (newTitle && newTitle.trim()) {
                chats[chatId].title = newTitle.trim()
                updateChatList()
                saveChats()
            }
        }

        // åˆ é™¤å¯¹è¯
        function deleteChat(chatId) {
            if (Object.keys(chats).length <= 1) {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªå¯¹è¯')
                return
            }
            
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ')) {
                delete chats[chatId]
                
                if (currentChatId === chatId) {
                    currentChatId = Object.keys(chats)[0]
                    loadMessages()
                }
                
                updateChatList()
                saveChats()
            }
        }

        // ä¿å­˜å¯¹è¯åˆ°localStorage
        function saveChats() {
            localStorage.setItem('claude_chats', JSON.stringify(chats))
        }

        // ä»localStorageåŠ è½½å¯¹è¯
        function loadChats() {
            const saved = localStorage.getItem('claude_chats')
            if (saved) {
                try {
                    chats = JSON.parse(saved)
                    updateChatList()
                    loadMessages()
                } catch (error) {
                    console.error('åŠ è½½å¯¹è¯å¤±è´¥:', error)
                }
            }
        }

        // æ¸…ç©ºå½“å‰å¯¹è¯
        function clearChat() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å—ï¼Ÿ')) {
                chats[currentChatId].messages = []
                loadMessages()
                saveChats()
            }
        }

        // å¯¼å‡ºå¯¹è¯
        function exportChat() {
            const chat = chats[currentChatId]
            if (chat.messages.length === 0) {
                alert('å½“å‰å¯¹è¯ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º')
                return
            }
            
            let exportText = `Claude Code å¯¹è¯è®°å½•\n`
            exportText += `æ ‡é¢˜: ${chat.title}\n`
            exportText += `åˆ›å»ºæ—¶é—´: ${new Date(chat.createdAt).toLocaleString()}\n`
            exportText += `å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}\n\n`
            
            chat.messages.forEach((msg, index) => {
                const role = msg.role === 'user' ? 'ç”¨æˆ·' : msg.role === 'assistant' ? 'AIåŠ©æ‰‹' : 'ç³»ç»Ÿ'
                exportText += `${index + 1}. ${role}:\n${msg.content}\n\n`
            })
            
            // åˆ›å»ºä¸‹è½½
            const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' })
            const url = URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.href = url
            a.download = `${chat.title}_${new Date().toISOString().slice(0, 10)}.txt`
            a.click()
            URL.revokeObjectURL(url)
        }

        // å¤åˆ¶æ¶ˆæ¯
        function copyMessage(button) {
            const messageText = button.closest('.message-content').querySelector('.message-text')
            const text = messageText.textContent || messageText.innerText
            
            navigator.clipboard.writeText(text).then(() => {
                button.textContent = 'å·²å¤åˆ¶'
                setTimeout(() => {
                    button.textContent = 'å¤åˆ¶'
                }, 1000)
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err)
                alert('å¤åˆ¶å¤±è´¥')
            })
        }

        // é‡æ–°ç”Ÿæˆæ¶ˆæ¯
        function regenerateMessage(button) {
            // TODO: å®ç°é‡æ–°ç”ŸæˆåŠŸèƒ½
            alert('é‡æ–°ç”ŸæˆåŠŸèƒ½å¼€å‘ä¸­...')
        }

        // åˆ‡æ¢ä¾§è¾¹æ 
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar')
            sidebar.classList.toggle('open')
        }

        // åˆ‡æ¢ä¸»é¢˜
        function toggleTheme() {
            document.body.classList.toggle('dark')
            const isDark = document.body.classList.contains('dark')
            localStorage.setItem('theme', isDark ? 'dark' : 'light')
            
            const themeBtn = document.querySelector('.theme-toggle')
            themeBtn.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™'
        }

        // åŠ è½½ä¸»é¢˜
        function loadTheme() {
            const theme = localStorage.getItem('theme')
            if (theme === 'dark') {
                document.body.classList.add('dark')
                document.querySelector('.theme-toggle').textContent = 'â˜€ï¸'
            }
        }

        // æ˜¾ç¤ºè®¾ç½®
        function showSettings() {
            const apiKey = localStorage.getItem('claude_api_key')
            const newApiKey = prompt('API Keyè®¾ç½®:', apiKey || '')
            
            if (newApiKey && newApiKey.trim()) {
                localStorage.setItem('claude_api_key', newApiKey.trim())
                location.reload() // é‡æ–°åŠ è½½åº”ç”¨
            }
        }

        // å“åº”å¼å¤„ç†
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                const sidebar = document.getElementById('sidebar')
                sidebar.classList.remove('open')
            }
        })
    </script>
</body>
</html>