<template>
  <div class="tab-content">
    <div class="card p-4 sm:p-6">
      <!-- È°µÈù¢Ê†áÈ¢ò -->
      <div class="mb-4 flex flex-col gap-4 sm:mb-6">
        <div>
          <h3 class="mb-1 text-lg font-bold text-gray-900 sm:mb-2 sm:text-xl">üß† Êô∫ËÉΩÈôêÊµÅÈÖçÁΩÆ</h3>
          <p class="text-sm text-gray-600 sm:text-base">
            Âü∫‰∫é‰∏äÊ∏∏ÈîôËØØÂÖ≥ÈîÆËØçÊô∫ËÉΩËß¶ÂèëÈôêÊµÅÔºå‰øùÊä§Ë¥¶Êà∑ÂÆâÂÖ®
          </p>
        </div>
      </div>

      <!-- ÂÖ®Â±ÄËÆæÁΩÆÂç°Áâá -->
      <el-card class="mb-6" header="ÂÖ®Â±ÄËÆæÁΩÆ">
        <el-form label-position="left" label-width="140px" :model="config.globalSettings">
          <el-row :gutter="24">
            <el-col :span="6">
              <el-form-item label="ÂêØÁî®Êô∫ËÉΩÈôêÊµÅ">
                <el-switch v-model="config.globalSettings.enabled" @change="updateGlobalSettings" />
              </el-form-item>
            </el-col>
            <el-col :span="6">
              <el-form-item label="ÈôêÊµÅÈªòËÆ§Êó∂Èïø">
                <el-input-number
                  v-model="config.globalSettings.defaultDuration"
                  :max="86400"
                  :min="60"
                  @change="updateGlobalSettings"
                />
                <span class="ml-2 text-gray-500">Áßí</span>
              </el-form-item>
            </el-col>
            <el-col :span="6">
              <el-form-item label="ÊÅ¢Â§çÊ£ÄÊü•Èó¥Èöî">
                <el-input-number
                  v-model="config.globalSettings.recoveryCheckInterval"
                  :max="600"
                  :min="30"
                  @change="updateGlobalSettings"
                />
                <span class="ml-2 text-gray-500">Áßí</span>
              </el-form-item>
            </el-col>
            <el-col :span="6">
              <el-form-item label="ÊúÄÂ§ßÈáçËØïÊ¨°Êï∞">
                <el-input-number
                  v-model="config.globalSettings.maxRetries"
                  :max="10"
                  :min="1"
                  @change="updateGlobalSettings"
                />
              </el-form-item>
            </el-col>
          </el-row>
        </el-form>
      </el-card>

      <!-- ÈÄâÈ°πÂç° -->
      <el-tabs v-model="activeTab" class="smart-tabs" type="card">
        <el-tab-pane :label="`‚ö° Á´ãÂç≥ÈôêÊµÅËßÑÂàô (${config.instantRules.length})`" name="instant">
          <!-- Â∑•ÂÖ∑Ê†è -->
          <div class="mb-4 flex gap-3">
            <el-button type="primary" @click="showAddInstantRule">
              <i class="fas fa-plus mr-2"></i>
              Ê∑ªÂä†ËßÑÂàô
            </el-button>
            <el-button @click="exportConfig">
              <i class="fas fa-download mr-2"></i>
              ÂØºÂá∫ÈÖçÁΩÆ
            </el-button>
            <el-button @click="showImportDialog = true">
              <i class="fas fa-upload mr-2"></i>
              ÂØºÂÖ•ÈÖçÁΩÆ
            </el-button>
          </div>

          <!-- ËßÑÂàôË°®Ê†º -->
          <el-table border :data="config.instantRules" stripe>
            <el-table-column align="center" label="ÂêØÁî®" width="80">
              <template #default="{ row }">
                <el-switch v-model="row.enabled" @change="updateRule('instant', row)" />
              </template>
            </el-table-column>
            <el-table-column label="ËßÑÂàôÂêçÁß∞" prop="name" />
            <el-table-column label="ÂÖ≥ÈîÆËØç" width="200">
              <template #default="{ row }">
                <code class="text-xs">{{ row.keywords.join(', ') }}</code>
              </template>
            </el-table-column>
            <el-table-column align="center" label="ÂåπÈÖçÊ®°Âºè" width="100">
              <template #default="{ row }">
                <el-tag size="small" :type="getMatchModeTagType(row.matchMode)">
                  {{ getMatchModeText(row.matchMode) }}
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column align="center" label="Âå∫ÂàÜÂ§ßÂ∞èÂÜô" width="120">
              <template #default="{ row }">
                <el-tag size="small" :type="row.caseSensitive ? 'warning' : 'info'">
                  {{ row.caseSensitive ? 'ÊòØ' : 'Âê¶' }}
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column align="center" label="ÈôêÊµÅÊó∂Èïø(Áßí)" width="120">
              <template #default="{ row }">
                {{ row.duration || config.globalSettings.defaultDuration }}
              </template>
            </el-table-column>
            <el-table-column align="center" label="‰ºòÂÖàÁ∫ß" prop="priority" width="80" />
            <el-table-column align="center" label="Ëß¶ÂèëÊ¨°Êï∞" width="100">
              <template #default="{ row }">
                {{ getStatistics('instant', row.id) }}
              </template>
            </el-table-column>
            <el-table-column align="center" label="Êìç‰Ωú" width="150">
              <template #default="{ row }">
                <el-button size="small" @click="editRule('instant', row)"> ÁºñËæë </el-button>
                <el-button size="small" type="danger" @click="deleteRule('instant', row.id)">
                  Âà†Èô§
                </el-button>
              </template>
            </el-table-column>
          </el-table>
        </el-tab-pane>

        <el-tab-pane
          :label="`üìä Á¥ØËÆ°Ëß¶ÂèëËßÑÂàô (${config.cumulativeRules.length})`"
          name="cumulative"
        >
          <!-- Â∑•ÂÖ∑Ê†è -->
          <div class="mb-4 flex gap-3">
            <el-button type="primary" @click="showAddCumulativeRule">
              <i class="fas fa-plus mr-2"></i>
              Ê∑ªÂä†ËßÑÂàô
            </el-button>
          </div>

          <!-- ËßÑÂàôË°®Ê†º -->
          <el-table border :data="config.cumulativeRules" stripe>
            <el-table-column align="center" label="ÂêØÁî®" width="80">
              <template #default="{ row }">
                <el-switch v-model="row.enabled" @change="updateRule('cumulative', row)" />
              </template>
            </el-table-column>
            <el-table-column label="ËßÑÂàôÂêçÁß∞" prop="name" />
            <el-table-column label="ÂÖ≥ÈîÆËØç" width="200">
              <template #default="{ row }">
                <code class="text-xs">{{ row.keywords.join(', ') }}</code>
              </template>
            </el-table-column>
            <el-table-column align="center" label="ÂåπÈÖçÊ®°Âºè" width="100">
              <template #default="{ row }">
                <el-tag size="small" :type="getMatchModeTagType(row.matchMode)">
                  {{ getMatchModeText(row.matchMode) }}
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column align="center" label="Ëß¶ÂèëÈòàÂÄº" prop="threshold" width="100" />
            <el-table-column align="center" label="Êó∂Èó¥Á™óÂè£(Áßí)" prop="windowSeconds" width="120" />
            <el-table-column align="center" label="ÈôêÊµÅÊó∂Èïø(Áßí)" width="120">
              <template #default="{ row }">
                {{ row.duration || config.globalSettings.defaultDuration }}
              </template>
            </el-table-column>
            <el-table-column align="center" label="‰ºòÂÖàÁ∫ß" prop="priority" width="80" />
            <el-table-column align="center" label="Ëß¶ÂèëÊ¨°Êï∞" width="100">
              <template #default="{ row }">
                {{ getStatistics('cumulative', row.id) }}
              </template>
            </el-table-column>
            <el-table-column align="center" label="Êìç‰Ωú" width="150">
              <template #default="{ row }">
                <el-button size="small" @click="editRule('cumulative', row)"> ÁºñËæë </el-button>
                <el-button size="small" type="danger" @click="deleteRule('cumulative', row.id)">
                  Âà†Èô§
                </el-button>
              </template>
            </el-table-column>
          </el-table>
        </el-tab-pane>

        <el-tab-pane :label="`üö´ Ë¢´ÈôêÊµÅË¥¶Êà∑ (${limitedAccounts.length})`" name="limited">
          <!-- Â∑•ÂÖ∑Ê†è -->
          <div class="mb-4 flex gap-3">
            <el-button
              :disabled="limitedAccounts.length === 0"
              type="warning"
              @click="clearAllRateLimits"
            >
              <i class="fas fa-unlock mr-2"></i>
              Ëß£Èô§ÊâÄÊúâÈôêÊµÅ
            </el-button>
            <el-button @click="refreshLimitedAccounts">
              <i class="fas fa-refresh mr-2"></i>
              Âà∑Êñ∞
            </el-button>
          </div>

          <!-- Ë¥¶Êà∑Ë°®Ê†º -->
          <el-table border :data="limitedAccounts" stripe>
            <el-table-column label="Ë¥¶Êà∑ID" width="120">
              <template #default="{ row }">
                <code class="text-xs">{{ row.accountId.substring(0, 8) }}...</code>
              </template>
            </el-table-column>
            <el-table-column label="Ë¥¶Êà∑ÂêçÁß∞">
              <template #default="{ row }">
                {{ row.accountName || 'Êú™Áü•' }}
              </template>
            </el-table-column>
            <el-table-column label="ÈôêÊµÅÂéüÂõ†" prop="reason" />
            <el-table-column align="center" label="Ëß¶ÂèëËßÑÂàô" width="120">
              <template #default="{ row }">
                <el-tag size="small" type="info">
                  {{ row.triggeredRule || 'ÊâãÂä®' }}
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column label="ÈôêÊµÅÊó∂Èó¥" width="180">
              <template #default="{ row }">
                {{ formatDate(row.limitedAt) }}
              </template>
            </el-table-column>
            <el-table-column align="center" label="Ââ©‰ΩôÊó∂Èó¥" width="120">
              <template #default="{ row }">
                <el-tag size="small" type="warning">
                  {{ formatRemainingTime(row.expiresAt) }}
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column align="center" label="Êìç‰Ωú" width="100">
              <template #default="{ row }">
                <el-button size="small" type="success" @click="removeRateLimit(row.accountId)">
                  Ëß£Èô§
                </el-button>
              </template>
            </el-table-column>
          </el-table>
        </el-tab-pane>

        <el-tab-pane label="üìà ÁªüËÆ°‰ø°ÊÅØ" name="statistics">
          <!-- ÁªüËÆ°Âç°Áâá -->
          <el-row class="mb-6" :gutter="16">
            <el-col :span="6">
              <el-statistic title="ÊÄªËß¶ÂèëÊ¨°Êï∞" :value="statistics.totalTriggers || 0" />
            </el-col>
            <el-col :span="6">
              <el-statistic title="Á´ãÂç≥ÈôêÊµÅËß¶Âèë" :value="statistics.instantTriggers || 0" />
            </el-col>
            <el-col :span="6">
              <el-statistic title="Á¥ØËÆ°ÈôêÊµÅËß¶Âèë" :value="statistics.cumulativeTriggers || 0" />
            </el-col>
            <el-col :span="6">
              <el-statistic title="ÂΩìÂâçÈôêÊµÅË¥¶Êà∑" :value="statistics.currentLimited || 0" />
            </el-col>
          </el-row>

          <!-- ËßÑÂàôËß¶ÂèëÊéíË°å -->
          <el-card header="ËßÑÂàôËß¶ÂèëÊéíË°å">
            <el-table border :data="topRules" stripe>
              <el-table-column label="ËßÑÂàôÂêçÁß∞" prop="ruleName" />
              <el-table-column align="center" label="Á±ªÂûã" width="100">
                <template #default="{ row }">
                  <el-tag size="small" :type="row.type === 'instant' ? 'danger' : 'warning'">
                    {{ row.type === 'instant' ? 'Á´ãÂç≥' : 'Á¥ØËÆ°' }}
                  </el-tag>
                </template>
              </el-table-column>
              <el-table-column align="center" label="Ëß¶ÂèëÊ¨°Êï∞" prop="triggerCount" width="120" />
              <el-table-column label="ÊúÄÂêéËß¶Âèë" width="180">
                <template #default="{ row }">
                  {{ formatDate(row.lastTriggered) }}
                </template>
              </el-table-column>
            </el-table>
          </el-card>
        </el-tab-pane>
      </el-tabs>

      <!-- Ê∑ªÂä†Á´ãÂç≥ÈôêÊµÅËßÑÂàôÂØπËØùÊ°Ü -->
      <el-dialog
        v-model="showInstantRuleDialog"
        :close-on-click-modal="false"
        :title="editingRule ? 'ÁºñËæëÁ´ãÂç≥ÈôêÊµÅËßÑÂàô' : 'Ê∑ªÂä†Á´ãÂç≥ÈôêÊµÅËßÑÂàô'"
        width="700px"
      >
        <el-form label-width="120px" :model="instantRuleForm">
          <el-form-item label="ËßÑÂàôÂêçÁß∞" required>
            <el-input v-model="instantRuleForm.name" placeholder="‰æãÂ¶ÇÔºöToken ËøáÊúüÈîôËØØ" />
          </el-form-item>
          <el-form-item label="ÂÖ≥ÈîÆËØçÂàóË°®" required>
            <el-input
              v-model="instantRuleForm.keywordsText"
              placeholder="ÊØèË°å‰∏Ä‰∏™ÂÖ≥ÈîÆËØçÔºå‰æãÂ¶ÇÔºö&#10;token_expired&#10;invalid_token&#10;authentication_failed"
              :rows="3"
              type="textarea"
            />
          </el-form-item>
          <el-row :gutter="16">
            <el-col :span="8">
              <el-form-item label="ÂåπÈÖçÊ®°Âºè">
                <el-select v-model="instantRuleForm.matchMode" style="width: 100%">
                  <el-option label="ÂåÖÂê´ÂåπÈÖç" value="contains" />
                  <el-option label="Á≤æÁ°ÆÂåπÈÖç" value="exact" />
                  <el-option label="Ê≠£ÂàôË°®ËææÂºè" value="regex" />
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="8">
              <el-form-item label="ÈôêÊµÅÊó∂ÈïøÔºàÁßíÔºâ">
                <el-input-number
                  v-model="instantRuleForm.duration"
                  :max="86400"
                  :min="60"
                  style="width: 100%"
                />
              </el-form-item>
            </el-col>
            <el-col :span="8">
              <el-form-item label="‰ºòÂÖàÁ∫ß">
                <el-input-number
                  v-model="instantRuleForm.priority"
                  :max="100"
                  :min="1"
                  style="width: 100%"
                />
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item>
            <el-checkbox v-model="instantRuleForm.caseSensitive">Âå∫ÂàÜÂ§ßÂ∞èÂÜô</el-checkbox>
            <el-checkbox v-model="instantRuleForm.enabled" class="ml-4">Á´ãÂç≥ÂêØÁî®ËßÑÂàô</el-checkbox>
          </el-form-item>
        </el-form>
        <template #footer>
          <el-button @click="closeInstantRuleDialog">ÂèñÊ∂à</el-button>
          <el-button type="primary" @click="saveInstantRule">
            {{ editingRule ? 'Êõ¥Êñ∞' : 'Ê∑ªÂä†' }}
          </el-button>
        </template>
      </el-dialog>

      <!-- Ê∑ªÂä†Á¥ØËÆ°Ëß¶ÂèëËßÑÂàôÂØπËØùÊ°Ü -->
      <el-dialog
        v-model="showCumulativeRuleDialog"
        :close-on-click-modal="false"
        :title="editingRule ? 'ÁºñËæëÁ¥ØËÆ°Ëß¶ÂèëËßÑÂàô' : 'Ê∑ªÂä†Á¥ØËÆ°Ëß¶ÂèëËßÑÂàô'"
        width="700px"
      >
        <el-form label-width="120px" :model="cumulativeRuleForm">
          <el-form-item label="ËßÑÂàôÂêçÁß∞" required>
            <el-input v-model="cumulativeRuleForm.name" placeholder="‰æãÂ¶ÇÔºöÈ¢ëÁπÅÈôêÊµÅÈîôËØØ" />
          </el-form-item>
          <el-form-item label="ÂÖ≥ÈîÆËØçÂàóË°®" required>
            <el-input
              v-model="cumulativeRuleForm.keywordsText"
              placeholder="ÊØèË°å‰∏Ä‰∏™ÂÖ≥ÈîÆËØç"
              :rows="3"
              type="textarea"
            />
          </el-form-item>
          <el-row :gutter="16">
            <el-col :span="6">
              <el-form-item label="ÂåπÈÖçÊ®°Âºè">
                <el-select v-model="cumulativeRuleForm.matchMode" style="width: 100%">
                  <el-option label="ÂåÖÂê´ÂåπÈÖç" value="contains" />
                  <el-option label="Á≤æÁ°ÆÂåπÈÖç" value="exact" />
                  <el-option label="Ê≠£ÂàôË°®ËææÂºè" value="regex" />
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="6">
              <el-form-item label="Ëß¶ÂèëÈòàÂÄº">
                <el-input-number
                  v-model="cumulativeRuleForm.threshold"
                  :max="100"
                  :min="2"
                  style="width: 100%"
                />
              </el-form-item>
            </el-col>
            <el-col :span="6">
              <el-form-item label="Êó∂Èó¥Á™óÂè£ÔºàÁßíÔºâ">
                <el-input-number
                  v-model="cumulativeRuleForm.windowSeconds"
                  :max="3600"
                  :min="60"
                  style="width: 100%"
                />
              </el-form-item>
            </el-col>
            <el-col :span="6">
              <el-form-item label="ÈôêÊµÅÊó∂ÈïøÔºàÁßíÔºâ">
                <el-input-number
                  v-model="cumulativeRuleForm.duration"
                  :max="86400"
                  :min="60"
                  style="width: 100%"
                />
              </el-form-item>
            </el-col>
          </el-row>
          <el-form-item label="‰ºòÂÖàÁ∫ß">
            <el-input-number
              v-model="cumulativeRuleForm.priority"
              :max="100"
              :min="1"
              style="width: 200px"
            />
          </el-form-item>
          <el-form-item>
            <el-checkbox v-model="cumulativeRuleForm.caseSensitive">Âå∫ÂàÜÂ§ßÂ∞èÂÜô</el-checkbox>
            <el-checkbox v-model="cumulativeRuleForm.enabled" class="ml-4"
              >Á´ãÂç≥ÂêØÁî®ËßÑÂàô</el-checkbox
            >
          </el-form-item>
        </el-form>
        <template #footer>
          <el-button @click="closeCumulativeRuleDialog">ÂèñÊ∂à</el-button>
          <el-button type="primary" @click="saveCumulativeRule">
            {{ editingRule ? 'Êõ¥Êñ∞' : 'Ê∑ªÂä†' }}
          </el-button>
        </template>
      </el-dialog>

      <!-- ÂØºÂÖ•ÈÖçÁΩÆÂØπËØùÊ°Ü -->
      <el-dialog
        v-model="showImportDialog"
        :close-on-click-modal="false"
        title="ÂØºÂÖ•ÈÖçÁΩÆ"
        width="700px"
      >
        <el-form>
          <el-form-item label="ÈÖçÁΩÆJSON">
            <el-input
              v-model="importConfigText"
              placeholder="Á≤òË¥¥ÂØºÂá∫ÁöÑÈÖçÁΩÆJSON"
              :rows="10"
              type="textarea"
            />
          </el-form-item>
          <el-form-item>
            <el-checkbox v-model="mergeImport">ÂêàÂπ∂Áé∞ÊúâÈÖçÁΩÆÔºà‰∏çÂãæÈÄâÂàôË¶ÜÁõñÔºâ</el-checkbox>
          </el-form-item>
        </el-form>
        <template #footer>
          <el-button @click="showImportDialog = false">ÂèñÊ∂à</el-button>
          <el-button type="primary" @click="importConfig">ÂØºÂÖ•</el-button>
        </template>
      </el-dialog>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted } from 'vue'
import { ElMessage } from 'element-plus'
import { useApi } from '@/composables/useApi'

const api = useApi()

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const config = ref({
  globalSettings: {
    enabled: true,
    defaultDuration: 300,
    recoveryCheckInterval: 60,
    maxRetries: 3
  },
  instantRules: [],
  cumulativeRules: []
})

const statistics = ref({})
const limitedAccounts = ref([])
const activeTab = ref('instant')
const showInstantRuleDialog = ref(false)
const showCumulativeRuleDialog = ref(false)
const showImportDialog = ref(false)
const editingRule = ref(null)
const refreshTimer = ref(null)

// Ë°®ÂçïÊï∞ÊçÆ
const instantRuleForm = ref({
  name: '',
  keywordsText: '',
  matchMode: 'contains',
  caseSensitive: false,
  duration: 300,
  priority: 50,
  enabled: true
})

const cumulativeRuleForm = ref({
  name: '',
  keywordsText: '',
  matchMode: 'contains',
  caseSensitive: false,
  threshold: 3,
  windowSeconds: 300,
  duration: 600,
  priority: 50,
  enabled: true
})

const importConfigText = ref('')
const mergeImport = ref(false)

// ËÆ°ÁÆóÂ±ûÊÄß
const topRules = computed(() => {
  if (!statistics.value.ruleStatistics) return []

  return Object.entries(statistics.value.ruleStatistics)
    .map(([ruleId, stats]) => ({
      ruleId,
      ruleName: stats.ruleName || ruleId,
      type: stats.type,
      triggerCount: stats.triggerCount || 0,
      lastTriggered: stats.lastTriggered
    }))
    .sort((a, b) => b.triggerCount - a.triggerCount)
    .slice(0, 10)
})

// Â∑•ÂÖ∑ÂáΩÊï∞
function getMatchModeTagType(mode) {
  const typeMap = {
    contains: 'info',
    exact: 'success',
    regex: 'danger'
  }
  return typeMap[mode] || 'info'
}

function getMatchModeText(mode) {
  const textMap = {
    contains: 'ÂåÖÂê´',
    exact: 'Á≤æÁ°Æ',
    regex: 'Ê≠£Âàô'
  }
  return textMap[mode] || mode
}

function getStatistics(type, ruleId) {
  if (!statistics.value.ruleStatistics) return 0
  const key = `${type}:${ruleId}`
  return statistics.value.ruleStatistics[key]?.triggerCount || 0
}

function formatDate(dateStr) {
  if (!dateStr) return '-'
  const date = new Date(dateStr)
  return date.toLocaleString('zh-CN')
}

function formatRemainingTime(expiresAt) {
  if (!expiresAt) return 'Ê∞∏‰πÖ'

  const now = Date.now()
  const expires = new Date(expiresAt).getTime()
  const remaining = expires - now

  if (remaining <= 0) return 'Â∑≤ËøáÊúü'

  const seconds = Math.floor(remaining / 1000)
  const minutes = Math.floor(seconds / 60)
  const hours = Math.floor(minutes / 60)

  if (hours > 0) {
    return `${hours}Â∞èÊó∂${minutes % 60}ÂàÜÈíü`
  } else if (minutes > 0) {
    return `${minutes}ÂàÜÈíü`
  } else {
    return `${seconds}Áßí`
  }
}

// API ÊñπÊ≥ï
async function loadConfig() {
  try {
    const response = await api.get('/admin/smart-rate-limit/config')
    if (response.data) {
      config.value = response.data
    }
  } catch (error) {
    console.error('Failed to load config:', error)
    ElMessage.error('Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•')
  }
}

async function loadStatistics() {
  try {
    const response = await api.get('/admin/smart-rate-limit/statistics')
    statistics.value = response.data || {}
  } catch (error) {
    console.error('Failed to load statistics:', error)
  }
}

async function loadLimitedAccounts() {
  try {
    const response = await api.get('/admin/smart-rate-limit/limited-accounts')
    limitedAccounts.value = response.data || []
  } catch (error) {
    console.error('Failed to load limited accounts:', error)
  }
}

async function updateGlobalSettings() {
  try {
    await api.put('/admin/smart-rate-limit/global-settings', config.value.globalSettings)
    ElMessage.success('ÂÖ®Â±ÄËÆæÁΩÆÂ∑≤Êõ¥Êñ∞')
  } catch (error) {
    console.error('Failed to update global settings:', error)
    ElMessage.error('Êõ¥Êñ∞ÂÖ®Â±ÄËÆæÁΩÆÂ§±Ë¥•')
  }
}

async function updateRule(type, rule) {
  try {
    await api.put(`/admin/smart-rate-limit/rules/${type}/${rule.id}`, rule)
  } catch (error) {
    console.error('Failed to update rule:', error)
    ElMessage.error('Êõ¥Êñ∞ËßÑÂàôÂ§±Ë¥•')
    await loadConfig()
  }
}

async function deleteRule(type, ruleId) {
  try {
    await api.delete(`/admin/smart-rate-limit/rules/${type}/${ruleId}`)
    ElMessage.success('ËßÑÂàôÂ∑≤Âà†Èô§')
    await loadConfig()
  } catch (error) {
    console.error('Failed to delete rule:', error)
    ElMessage.error('Âà†Èô§ËßÑÂàôÂ§±Ë¥•')
  }
}

async function removeRateLimit(accountId) {
  try {
    await api.delete(`/admin/smart-rate-limit/limited-accounts/${accountId}`)
    ElMessage.success('ÈôêÊµÅÂ∑≤Ëß£Èô§')
    await loadLimitedAccounts()
  } catch (error) {
    console.error('Failed to remove rate limit:', error)
    ElMessage.error('Ëß£Èô§ÈôêÊµÅÂ§±Ë¥•')
  }
}

async function clearAllRateLimits() {
  try {
    await api.post('/admin/smart-rate-limit/clear-all')
    ElMessage.success('ÊâÄÊúâÈôêÊµÅÂ∑≤Ëß£Èô§')
    await loadLimitedAccounts()
  } catch (error) {
    console.error('Failed to clear all rate limits:', error)
    ElMessage.error('Ê∏ÖÈô§ÈôêÊµÅÂ§±Ë¥•')
  }
}

async function exportConfig() {
  try {
    const response = await api.get('/admin/smart-rate-limit/export')
    const blob = new Blob([JSON.stringify(response.data, null, 2)], { type: 'application/json' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `smart-rate-limit-config-${Date.now()}.json`
    a.click()
    URL.revokeObjectURL(url)
    ElMessage.success('ÈÖçÁΩÆÂ∑≤ÂØºÂá∫')
  } catch (error) {
    console.error('Failed to export config:', error)
    ElMessage.error('ÂØºÂá∫ÈÖçÁΩÆÂ§±Ë¥•')
  }
}

async function importConfig() {
  try {
    const configData = JSON.parse(importConfigText.value)
    await api.post('/admin/smart-rate-limit/import', {
      config: configData,
      merge: mergeImport.value
    })
    ElMessage.success('ÈÖçÁΩÆÂ∑≤ÂØºÂÖ•')
    showImportDialog.value = false
    importConfigText.value = ''
    await loadConfig()
  } catch (error) {
    console.error('Failed to import config:', error)
    ElMessage.error('ÂØºÂÖ•ÈÖçÁΩÆÂ§±Ë¥•Ôºö' + error.message)
  }
}

function showAddInstantRule() {
  editingRule.value = null
  instantRuleForm.value = {
    name: '',
    keywordsText: '',
    matchMode: 'contains',
    caseSensitive: false,
    duration: 300,
    priority: 50,
    enabled: true
  }
  showInstantRuleDialog.value = true
}

function showAddCumulativeRule() {
  editingRule.value = null
  cumulativeRuleForm.value = {
    name: '',
    keywordsText: '',
    matchMode: 'contains',
    caseSensitive: false,
    threshold: 3,
    windowSeconds: 300,
    duration: 600,
    priority: 50,
    enabled: true
  }
  showCumulativeRuleDialog.value = true
}

function editRule(type, rule) {
  editingRule.value = rule
  if (type === 'instant') {
    instantRuleForm.value = {
      name: rule.name,
      keywordsText: rule.keywords.join('\n'),
      matchMode: rule.matchMode,
      caseSensitive: rule.caseSensitive,
      duration: rule.duration,
      priority: rule.priority,
      enabled: rule.enabled
    }
    showInstantRuleDialog.value = true
  } else {
    cumulativeRuleForm.value = {
      name: rule.name,
      keywordsText: rule.keywords.join('\n'),
      matchMode: rule.matchMode,
      caseSensitive: rule.caseSensitive,
      threshold: rule.threshold,
      windowSeconds: rule.windowSeconds,
      duration: rule.duration,
      priority: rule.priority,
      enabled: rule.enabled
    }
    showCumulativeRuleDialog.value = true
  }
}

async function saveInstantRule() {
  try {
    const keywords = instantRuleForm.value.keywordsText
      .split('\n')
      .map((k) => k.trim())
      .filter((k) => k)

    if (!instantRuleForm.value.name || keywords.length === 0) {
      ElMessage.error('ËØ∑Â°´ÂÜôËßÑÂàôÂêçÁß∞ÂíåÂÖ≥ÈîÆËØç')
      return
    }

    const ruleData = {
      name: instantRuleForm.value.name,
      keywords,
      matchMode: instantRuleForm.value.matchMode,
      caseSensitive: instantRuleForm.value.caseSensitive,
      duration: instantRuleForm.value.duration,
      priority: instantRuleForm.value.priority,
      enabled: instantRuleForm.value.enabled
    }

    if (editingRule.value) {
      await api.put(`/admin/smart-rate-limit/rules/instant/${editingRule.value.id}`, ruleData)
      ElMessage.success('ËßÑÂàôÂ∑≤Êõ¥Êñ∞')
    } else {
      await api.post('/admin/smart-rate-limit/rules/instant', ruleData)
      ElMessage.success('ËßÑÂàôÂ∑≤Ê∑ªÂä†')
    }

    closeInstantRuleDialog()
    await loadConfig()
  } catch (error) {
    console.error('Failed to save instant rule:', error)
    ElMessage.error('‰øùÂ≠òËßÑÂàôÂ§±Ë¥•')
  }
}

async function saveCumulativeRule() {
  try {
    const keywords = cumulativeRuleForm.value.keywordsText
      .split('\n')
      .map((k) => k.trim())
      .filter((k) => k)

    if (!cumulativeRuleForm.value.name || keywords.length === 0) {
      ElMessage.error('ËØ∑Â°´ÂÜôËßÑÂàôÂêçÁß∞ÂíåÂÖ≥ÈîÆËØç')
      return
    }

    const ruleData = {
      name: cumulativeRuleForm.value.name,
      keywords,
      matchMode: cumulativeRuleForm.value.matchMode,
      caseSensitive: cumulativeRuleForm.value.caseSensitive,
      threshold: cumulativeRuleForm.value.threshold,
      windowSeconds: cumulativeRuleForm.value.windowSeconds,
      duration: cumulativeRuleForm.value.duration,
      priority: cumulativeRuleForm.value.priority,
      enabled: cumulativeRuleForm.value.enabled
    }

    if (editingRule.value) {
      await api.put(`/admin/smart-rate-limit/rules/cumulative/${editingRule.value.id}`, ruleData)
      ElMessage.success('ËßÑÂàôÂ∑≤Êõ¥Êñ∞')
    } else {
      await api.post('/admin/smart-rate-limit/rules/cumulative', ruleData)
      ElMessage.success('ËßÑÂàôÂ∑≤Ê∑ªÂä†')
    }

    closeCumulativeRuleDialog()
    await loadConfig()
  } catch (error) {
    console.error('Failed to save cumulative rule:', error)
    ElMessage.error('‰øùÂ≠òËßÑÂàôÂ§±Ë¥•')
  }
}

function closeInstantRuleDialog() {
  showInstantRuleDialog.value = false
  editingRule.value = null
}

function closeCumulativeRuleDialog() {
  showCumulativeRuleDialog.value = false
  editingRule.value = null
}

function refreshLimitedAccounts() {
  loadLimitedAccounts()
  loadStatistics()
}

// Ëá™Âä®Âà∑Êñ∞
function startAutoRefresh() {
  refreshTimer.value = setInterval(() => {
    if (activeTab.value === 'limited') {
      loadLimitedAccounts()
    } else if (activeTab.value === 'statistics') {
      loadStatistics()
    }
  }, 5000)
}

function stopAutoRefresh() {
  if (refreshTimer.value) {
    clearInterval(refreshTimer.value)
    refreshTimer.value = null
  }
}

// ÁîüÂëΩÂë®ÊúüÈí©Â≠ê
onMounted(() => {
  loadConfig()
  loadStatistics()
  loadLimitedAccounts()
  startAutoRefresh()
})

onUnmounted(() => {
  stopAutoRefresh()
})
</script>

<style scoped>
.smart-tabs :deep(.el-tabs__content) {
  padding-top: 20px;
}

:deep(.el-statistic__content) {
  font-size: 2rem;
  font-weight: 600;
}

:deep(.el-statistic__head) {
  color: #666;
  font-size: 14px;
  margin-bottom: 8px;
}

.ml-2 {
  margin-left: 8px;
}

.ml-4 {
  margin-left: 16px;
}

.mr-2 {
  margin-right: 8px;
}

.text-xs {
  font-size: 12px;
}
</style>
