<template>
  <div class="smart-rate-limit-view">
    <!-- È°µÈù¢Ê†áÈ¢ò -->
    <div class="page-header">
      <h1 class="page-title">
        <span class="icon">üß†</span>
        Êô∫ËÉΩÈôêÊµÅÈÖçÁΩÆ
      </h1>
      <p class="page-description">Âü∫‰∫é‰∏äÊ∏∏ÈîôËØØÂÖ≥ÈîÆËØçÊô∫ËÉΩËß¶ÂèëÈôêÊµÅÔºå‰øùÊä§Ë¥¶Êà∑ÂÆâÂÖ®</p>
    </div>

    <!-- ÂÖ®Â±ÄËÆæÁΩÆÂç°Áâá -->
    <n-card :bordered="false" class="settings-card" title="ÂÖ®Â±ÄËÆæÁΩÆ">
      <n-form label-placement="left" label-width="140" :model="config.globalSettings">
        <n-grid :cols="4" :x-gap="24" :y-gap="16">
          <n-grid-item>
            <n-form-item label="ÈôêÊµÅÈªòËÆ§Êó∂Èïø">
              <n-input-number
                v-model:value="config.globalSettings.defaultDuration"
                :max="86400"
                :min="60"
                @update:value="updateGlobalSettings"
              >
                <template #suffix>Áßí</template>
              </n-input-number>
            </n-form-item>
          </n-grid-item>
          <n-grid-item>
            <n-form-item label="ÊÅ¢Â§çÊ£ÄÊü•Èó¥Èöî">
              <n-input-number
                v-model:value="config.globalSettings.recoveryCheckInterval"
                :max="600"
                :min="30"
                @update:value="updateGlobalSettings"
              >
                <template #suffix>Áßí</template>
              </n-input-number>
            </n-form-item>
          </n-grid-item>
          <n-grid-item>
            <n-form-item label="ÊúÄÂ§ßÈáçËØïÊ¨°Êï∞">
              <n-input-number
                v-model:value="config.globalSettings.maxRetries"
                :max="10"
                :min="1"
                @update:value="updateGlobalSettings"
              />
            </n-form-item>
          </n-grid-item>
          <n-grid-item>
            <n-form-item label="ÂêØÁî®Êô∫ËÉΩÈôêÊµÅ">
              <n-switch
                v-model:value="config.globalSettings.enabled"
                @update:value="updateGlobalSettings"
              />
            </n-form-item>
          </n-grid-item>
        </n-grid>
      </n-form>
    </n-card>

    <!-- ÈÄâÈ°πÂç° -->
    <n-tabs v-model:value="activeTab" class="tabs-container" type="card">
      <n-tab-pane name="instant" :tab="`‚ö° Á´ãÂç≥ÈôêÊµÅËßÑÂàô (${config.instantRules.length})`">
        <div class="tab-content">
          <!-- Â∑•ÂÖ∑Ê†è -->
          <div class="toolbar">
            <n-button type="primary" @click="showAddInstantRule = true">
              <template #icon>
                <n-icon><AddIcon /></n-icon>
              </template>
              Ê∑ªÂä†ËßÑÂàô
            </n-button>
            <n-button @click="exportConfig">
              <template #icon>
                <n-icon><DownloadIcon /></n-icon>
              </template>
              ÂØºÂá∫ÈÖçÁΩÆ
            </n-button>
            <n-button @click="showImportDialog = true">
              <template #icon>
                <n-icon><UploadIcon /></n-icon>
              </template>
              ÂØºÂÖ•ÈÖçÁΩÆ
            </n-button>
          </div>

          <!-- ËßÑÂàôË°®Ê†º -->
          <n-data-table
            :bordered="false"
            :columns="instantRuleColumns"
            :data="config.instantRules"
            :pagination="false"
            striped
          />
        </div>
      </n-tab-pane>

      <n-tab-pane name="cumulative" :tab="`üìä Á¥ØËÆ°Ëß¶ÂèëËßÑÂàô (${config.cumulativeRules.length})`">
        <div class="tab-content">
          <!-- Â∑•ÂÖ∑Ê†è -->
          <div class="toolbar">
            <n-button type="primary" @click="showAddCumulativeRule = true">
              <template #icon>
                <n-icon><AddIcon /></n-icon>
              </template>
              Ê∑ªÂä†ËßÑÂàô
            </n-button>
          </div>

          <!-- ËßÑÂàôË°®Ê†º -->
          <n-data-table
            :bordered="false"
            :columns="cumulativeRuleColumns"
            :data="config.cumulativeRules"
            :pagination="false"
            striped
          />
        </div>
      </n-tab-pane>

      <n-tab-pane name="limited" :tab="`üö´ Ë¢´ÈôêÊµÅË¥¶Êà∑ (${limitedAccounts.length})`">
        <div class="tab-content">
          <!-- Â∑•ÂÖ∑Ê†è -->
          <div class="toolbar">
            <n-button
              :disabled="limitedAccounts.length === 0"
              type="warning"
              @click="clearAllRateLimits"
            >
              <template #icon>
                <n-icon><UnlockIcon /></n-icon>
              </template>
              Ëß£Èô§ÊâÄÊúâÈôêÊµÅ
            </n-button>
            <n-button @click="refreshLimitedAccounts">
              <template #icon>
                <n-icon><RefreshIcon /></n-icon>
              </template>
              Âà∑Êñ∞
            </n-button>
          </div>

          <!-- Ë¥¶Êà∑Ë°®Ê†º -->
          <n-data-table
            :bordered="false"
            :columns="limitedAccountColumns"
            :data="limitedAccounts"
            :pagination="false"
            striped
          />
        </div>
      </n-tab-pane>

      <n-tab-pane name="statistics" tab="üìà ÁªüËÆ°‰ø°ÊÅØ">
        <div class="tab-content">
          <!-- ÁªüËÆ°Âç°Áâá -->
          <n-grid class="stats-grid" :cols="4" :x-gap="16" :y-gap="16">
            <n-grid-item>
              <n-statistic label="ÊÄªËß¶ÂèëÊ¨°Êï∞" :value="statistics.totalTriggers || 0" />
            </n-grid-item>
            <n-grid-item>
              <n-statistic label="Á´ãÂç≥ÈôêÊµÅËß¶Âèë" :value="statistics.instantTriggers || 0" />
            </n-grid-item>
            <n-grid-item>
              <n-statistic label="Á¥ØËÆ°ÈôêÊµÅËß¶Âèë" :value="statistics.cumulativeTriggers || 0" />
            </n-grid-item>
            <n-grid-item>
              <n-statistic label="ÂΩìÂâçÈôêÊµÅË¥¶Êà∑" :value="statistics.currentLimited || 0" />
            </n-grid-item>
          </n-grid>

          <!-- ËßÑÂàôËß¶ÂèëÊéíË°å -->
          <n-card :bordered="false" class="ranking-card" title="ËßÑÂàôËß¶ÂèëÊéíË°å">
            <n-data-table
              :bordered="false"
              :columns="topRulesColumns"
              :data="topRules"
              :pagination="false"
              striped
            />
          </n-card>
        </div>
      </n-tab-pane>
    </n-tabs>

    <!-- Ê∑ªÂä†Á´ãÂç≥ÈôêÊµÅËßÑÂàôÂØπËØùÊ°Ü -->
    <n-modal
      v-model:show="showAddInstantRule"
      :mask-closable="false"
      preset="dialog"
      style="width: 700px"
      :title="editingRule ? 'ÁºñËæëÁ´ãÂç≥ÈôêÊµÅËßÑÂàô' : 'Ê∑ªÂä†Á´ãÂç≥ÈôêÊµÅËßÑÂàô'"
    >
      <n-form label-placement="top" :model="instantRuleForm">
        <n-form-item label="ËßÑÂàôÂêçÁß∞" required>
          <n-input v-model:value="instantRuleForm.name" placeholder="‰æãÂ¶ÇÔºöToken ËøáÊúüÈîôËØØ" />
        </n-form-item>
        <n-form-item label="ÂÖ≥ÈîÆËØçÂàóË°®" required>
          <n-input
            v-model:value="instantRuleForm.keywordsText"
            placeholder="ÊØèË°å‰∏Ä‰∏™ÂÖ≥ÈîÆËØçÔºå‰æãÂ¶ÇÔºö&#10;token_expired&#10;invalid_token&#10;authentication_failed"
            :rows="3"
            type="textarea"
          />
        </n-form-item>
        <n-grid :cols="3" :x-gap="16">
          <n-grid-item>
            <n-form-item label="ÂåπÈÖçÊ®°Âºè">
              <n-select v-model:value="instantRuleForm.matchMode" :options="matchModeOptions" />
            </n-form-item>
          </n-grid-item>
          <n-grid-item>
            <n-form-item label="ÈôêÊµÅÊó∂ÈïøÔºàÁßíÔºâ">
              <n-input-number v-model:value="instantRuleForm.duration" :max="86400" :min="60" />
            </n-form-item>
          </n-grid-item>
          <n-grid-item>
            <n-form-item label="‰ºòÂÖàÁ∫ß">
              <n-input-number v-model:value="instantRuleForm.priority" :max="100" :min="1" />
            </n-form-item>
          </n-grid-item>
        </n-grid>
        <n-space>
          <n-checkbox v-model:checked="instantRuleForm.caseSensitive">Âå∫ÂàÜÂ§ßÂ∞èÂÜô</n-checkbox>
          <n-checkbox v-model:checked="instantRuleForm.enabled">Á´ãÂç≥ÂêØÁî®ËßÑÂàô</n-checkbox>
        </n-space>
      </n-form>
      <template #action>
        <n-space>
          <n-button @click="closeInstantRuleDialog">ÂèñÊ∂à</n-button>
          <n-button type="primary" @click="saveInstantRule">
            {{ editingRule ? 'Êõ¥Êñ∞' : 'Ê∑ªÂä†' }}
          </n-button>
        </n-space>
      </template>
    </n-modal>

    <!-- Ê∑ªÂä†Á¥ØËÆ°Ëß¶ÂèëËßÑÂàôÂØπËØùÊ°Ü -->
    <n-modal
      v-model:show="showAddCumulativeRule"
      :mask-closable="false"
      preset="dialog"
      style="width: 700px"
      :title="editingRule ? 'ÁºñËæëÁ¥ØËÆ°Ëß¶ÂèëËßÑÂàô' : 'Ê∑ªÂä†Á¥ØËÆ°Ëß¶ÂèëËßÑÂàô'"
    >
      <n-form label-placement="top" :model="cumulativeRuleForm">
        <n-form-item label="ËßÑÂàôÂêçÁß∞" required>
          <n-input v-model:value="cumulativeRuleForm.name" placeholder="‰æãÂ¶ÇÔºöÈ¢ëÁπÅÈôêÊµÅÈîôËØØ" />
        </n-form-item>
        <n-form-item label="ÂÖ≥ÈîÆËØçÂàóË°®" required>
          <n-input
            v-model:value="cumulativeRuleForm.keywordsText"
            placeholder="ÊØèË°å‰∏Ä‰∏™ÂÖ≥ÈîÆËØç"
            :rows="3"
            type="textarea"
          />
        </n-form-item>
        <n-grid :cols="4" :x-gap="16">
          <n-grid-item>
            <n-form-item label="ÂåπÈÖçÊ®°Âºè">
              <n-select v-model:value="cumulativeRuleForm.matchMode" :options="matchModeOptions" />
            </n-form-item>
          </n-grid-item>
          <n-grid-item>
            <n-form-item label="Ëß¶ÂèëÈòàÂÄº">
              <n-input-number v-model:value="cumulativeRuleForm.threshold" :max="100" :min="2" />
            </n-form-item>
          </n-grid-item>
          <n-grid-item>
            <n-form-item label="Êó∂Èó¥Á™óÂè£ÔºàÁßíÔºâ">
              <n-input-number
                v-model:value="cumulativeRuleForm.windowSeconds"
                :max="3600"
                :min="60"
              />
            </n-form-item>
          </n-grid-item>
          <n-grid-item>
            <n-form-item label="ÈôêÊµÅÊó∂ÈïøÔºàÁßíÔºâ">
              <n-input-number v-model:value="cumulativeRuleForm.duration" :max="86400" :min="60" />
            </n-form-item>
          </n-grid-item>
        </n-grid>
        <n-form-item label="‰ºòÂÖàÁ∫ß">
          <n-input-number
            v-model:value="cumulativeRuleForm.priority"
            :max="100"
            :min="1"
            style="width: 200px"
          />
        </n-form-item>
        <n-space>
          <n-checkbox v-model:checked="cumulativeRuleForm.caseSensitive">Âå∫ÂàÜÂ§ßÂ∞èÂÜô</n-checkbox>
          <n-checkbox v-model:checked="cumulativeRuleForm.enabled">Á´ãÂç≥ÂêØÁî®ËßÑÂàô</n-checkbox>
        </n-space>
      </n-form>
      <template #action>
        <n-space>
          <n-button @click="closeCumulativeRuleDialog">ÂèñÊ∂à</n-button>
          <n-button type="primary" @click="saveCumulativeRule">
            {{ editingRule ? 'Êõ¥Êñ∞' : 'Ê∑ªÂä†' }}
          </n-button>
        </n-space>
      </template>
    </n-modal>

    <!-- ÂØºÂÖ•ÈÖçÁΩÆÂØπËØùÊ°Ü -->
    <n-modal
      v-model:show="showImportDialog"
      :mask-closable="false"
      preset="dialog"
      style="width: 700px"
      title="ÂØºÂÖ•ÈÖçÁΩÆ"
    >
      <n-form>
        <n-form-item label="ÈÖçÁΩÆJSON">
          <n-input
            v-model:value="importConfigText"
            placeholder="Á≤òË¥¥ÂØºÂá∫ÁöÑÈÖçÁΩÆJSON"
            :rows="10"
            type="textarea"
          />
        </n-form-item>
        <n-checkbox v-model:checked="mergeImport">ÂêàÂπ∂Áé∞ÊúâÈÖçÁΩÆÔºà‰∏çÂãæÈÄâÂàôË¶ÜÁõñÔºâ</n-checkbox>
      </n-form>
      <template #action>
        <n-space>
          <n-button @click="showImportDialog = false">ÂèñÊ∂à</n-button>
          <n-button type="primary" @click="importConfig">ÂØºÂÖ•</n-button>
        </n-space>
      </template>
    </n-modal>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted, h } from 'vue'
import { useMessage } from 'naive-ui'
import { NButton, NTag, NSwitch, NSpace } from 'naive-ui'
import {
  Add as AddIcon,
  Download as DownloadIcon,
  Upload as UploadIcon,
  Refresh as RefreshIcon,
  LockOpen as UnlockIcon
} from '@vicons/ionicons5'
import api from '@/api'

const message = useMessage()

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const config = ref({
  globalSettings: {
    enabled: true,
    defaultDuration: 300,
    recoveryCheckInterval: 60,
    maxRetries: 3
  },
  instantRules: [],
  cumulativeRules: []
})

const statistics = ref({})
const limitedAccounts = ref([])
const activeTab = ref('instant')
const showAddInstantRule = ref(false)
const showAddCumulativeRule = ref(false)
const showImportDialog = ref(false)
const editingRule = ref(null)
const refreshTimer = ref(null)

// Ë°®ÂçïÊï∞ÊçÆ
const instantRuleForm = ref({
  name: '',
  keywordsText: '',
  matchMode: 'contains',
  caseSensitive: false,
  duration: 300,
  priority: 50,
  enabled: true
})

const cumulativeRuleForm = ref({
  name: '',
  keywordsText: '',
  matchMode: 'contains',
  caseSensitive: false,
  threshold: 3,
  windowSeconds: 300,
  duration: 600,
  priority: 50,
  enabled: true
})

const importConfigText = ref('')
const mergeImport = ref(false)

// ÈÄâÈ°πÈÖçÁΩÆ
const matchModeOptions = [
  { label: 'ÂåÖÂê´ÂåπÈÖç', value: 'contains' },
  { label: 'Á≤æÁ°ÆÂåπÈÖç', value: 'exact' },
  { label: 'Ê≠£ÂàôË°®ËææÂºè', value: 'regex' }
]

// ËÆ°ÁÆóÂ±ûÊÄß
const topRules = computed(() => {
  if (!statistics.value.ruleStatistics) return []

  return Object.entries(statistics.value.ruleStatistics)
    .map(([ruleId, stats]) => ({
      ruleId,
      ruleName: stats.ruleName || ruleId,
      type: stats.type,
      triggerCount: stats.triggerCount || 0,
      lastTriggered: stats.lastTriggered
    }))
    .sort((a, b) => b.triggerCount - a.triggerCount)
    .slice(0, 10)
})

// Ë°®Ê†ºÂàóÈÖçÁΩÆ
const instantRuleColumns = [
  {
    title: 'ÂêØÁî®',
    key: 'enabled',
    width: 80,
    render(row) {
      return h(NSwitch, {
        value: row.enabled,
        onUpdateValue: (val) => {
          row.enabled = val
          updateRule('instant', row)
        }
      })
    }
  },
  {
    title: 'ËßÑÂàôÂêçÁß∞',
    key: 'name'
  },
  {
    title: 'ÂÖ≥ÈîÆËØç',
    key: 'keywords',
    render(row) {
      return h('code', row.keywords.join(', '))
    }
  },
  {
    title: 'ÂåπÈÖçÊ®°Âºè',
    key: 'matchMode',
    render(row) {
      const typeMap = {
        contains: { type: 'info', text: 'ÂåÖÂê´' },
        exact: { type: 'success', text: 'Á≤æÁ°Æ' },
        regex: { type: 'error', text: 'Ê≠£Âàô' }
      }
      const info = typeMap[row.matchMode] || { type: 'default', text: row.matchMode }
      return h(NTag, { type: info.type, size: 'small' }, () => info.text)
    }
  },
  {
    title: 'Âå∫ÂàÜÂ§ßÂ∞èÂÜô',
    key: 'caseSensitive',
    render(row) {
      return h(
        NTag,
        {
          type: row.caseSensitive ? 'warning' : 'default',
          size: 'small'
        },
        () => (row.caseSensitive ? 'ÊòØ' : 'Âê¶')
      )
    }
  },
  {
    title: 'ÈôêÊµÅÊó∂Èïø(Áßí)',
    key: 'duration',
    render(row) {
      return row.duration || config.value.globalSettings.defaultDuration
    }
  },
  {
    title: '‰ºòÂÖàÁ∫ß',
    key: 'priority'
  },
  {
    title: 'Ëß¶ÂèëÊ¨°Êï∞',
    key: 'triggerCount',
    render(row) {
      return getStatistics('instant', row.id)
    }
  },
  {
    title: 'Êìç‰Ωú',
    key: 'actions',
    width: 150,
    render(row) {
      return h(NSpace, null, () => [
        h(
          NButton,
          {
            size: 'small',
            onClick: () => editRule('instant', row)
          },
          () => 'ÁºñËæë'
        ),
        h(
          NButton,
          {
            size: 'small',
            type: 'error',
            onClick: () => deleteRule('instant', row.id)
          },
          () => 'Âà†Èô§'
        )
      ])
    }
  }
]

const cumulativeRuleColumns = [
  {
    title: 'ÂêØÁî®',
    key: 'enabled',
    width: 80,
    render(row) {
      return h(NSwitch, {
        value: row.enabled,
        onUpdateValue: (val) => {
          row.enabled = val
          updateRule('cumulative', row)
        }
      })
    }
  },
  {
    title: 'ËßÑÂàôÂêçÁß∞',
    key: 'name'
  },
  {
    title: 'ÂÖ≥ÈîÆËØç',
    key: 'keywords',
    render(row) {
      return h('code', row.keywords.join(', '))
    }
  },
  {
    title: 'ÂåπÈÖçÊ®°Âºè',
    key: 'matchMode',
    render(row) {
      const typeMap = {
        contains: { type: 'info', text: 'ÂåÖÂê´' },
        exact: { type: 'success', text: 'Á≤æÁ°Æ' },
        regex: { type: 'error', text: 'Ê≠£Âàô' }
      }
      const info = typeMap[row.matchMode] || { type: 'default', text: row.matchMode }
      return h(NTag, { type: info.type, size: 'small' }, () => info.text)
    }
  },
  {
    title: 'Ëß¶ÂèëÈòàÂÄº',
    key: 'threshold'
  },
  {
    title: 'Êó∂Èó¥Á™óÂè£(Áßí)',
    key: 'windowSeconds'
  },
  {
    title: 'ÈôêÊµÅÊó∂Èïø(Áßí)',
    key: 'duration',
    render(row) {
      return row.duration || config.value.globalSettings.defaultDuration
    }
  },
  {
    title: '‰ºòÂÖàÁ∫ß',
    key: 'priority'
  },
  {
    title: 'Ëß¶ÂèëÊ¨°Êï∞',
    key: 'triggerCount',
    render(row) {
      return getStatistics('cumulative', row.id)
    }
  },
  {
    title: 'Êìç‰Ωú',
    key: 'actions',
    width: 150,
    render(row) {
      return h(NSpace, null, () => [
        h(
          NButton,
          {
            size: 'small',
            onClick: () => editRule('cumulative', row)
          },
          () => 'ÁºñËæë'
        ),
        h(
          NButton,
          {
            size: 'small',
            type: 'error',
            onClick: () => deleteRule('cumulative', row.id)
          },
          () => 'Âà†Èô§'
        )
      ])
    }
  }
]

const limitedAccountColumns = [
  {
    title: 'Ë¥¶Êà∑ID',
    key: 'accountId',
    render(row) {
      return h('code', row.accountId.substring(0, 8) + '...')
    }
  },
  {
    title: 'Ë¥¶Êà∑ÂêçÁß∞',
    key: 'accountName',
    render(row) {
      return row.accountName || 'Êú™Áü•'
    }
  },
  {
    title: 'ÈôêÊµÅÂéüÂõ†',
    key: 'reason'
  },
  {
    title: 'Ëß¶ÂèëËßÑÂàô',
    key: 'triggeredRule',
    render(row) {
      return h(NTag, { type: 'info', size: 'small' }, () => row.triggeredRule || 'ÊâãÂä®')
    }
  },
  {
    title: 'ÈôêÊµÅÊó∂Èó¥',
    key: 'limitedAt',
    render(row) {
      return formatDate(row.limitedAt)
    }
  },
  {
    title: 'Ââ©‰ΩôÊó∂Èó¥',
    key: 'expiresAt',
    render(row) {
      return h(NTag, { type: 'warning', size: 'small' }, () => formatRemainingTime(row.expiresAt))
    }
  },
  {
    title: 'Êìç‰Ωú',
    key: 'actions',
    width: 100,
    render(row) {
      return h(
        NButton,
        {
          size: 'small',
          type: 'success',
          onClick: () => removeRateLimit(row.accountId)
        },
        () => 'Ëß£Èô§'
      )
    }
  }
]

const topRulesColumns = [
  {
    title: 'ËßÑÂàôÂêçÁß∞',
    key: 'ruleName'
  },
  {
    title: 'Á±ªÂûã',
    key: 'type',
    render(row) {
      return h(
        NTag,
        {
          type: row.type === 'instant' ? 'error' : 'warning',
          size: 'small'
        },
        () => (row.type === 'instant' ? 'Á´ãÂç≥' : 'Á¥ØËÆ°')
      )
    }
  },
  {
    title: 'Ëß¶ÂèëÊ¨°Êï∞',
    key: 'triggerCount'
  },
  {
    title: 'ÊúÄÂêéËß¶Âèë',
    key: 'lastTriggered',
    render(row) {
      return formatDate(row.lastTriggered)
    }
  }
]

// API ÊñπÊ≥ï
async function loadConfig() {
  try {
    const response = await api.get('/smart-rate-limit/config')
    config.value = response.data || config.value
  } catch (error) {
    console.error('Failed to load config:', error)
    message.error('Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•')
  }
}

async function loadStatistics() {
  try {
    const response = await api.get('/smart-rate-limit/statistics')
    statistics.value = response.data || {}
  } catch (error) {
    console.error('Failed to load statistics:', error)
  }
}

async function loadLimitedAccounts() {
  try {
    const response = await api.get('/smart-rate-limit/limited-accounts')
    limitedAccounts.value = response.data || []
  } catch (error) {
    console.error('Failed to load limited accounts:', error)
  }
}

async function updateGlobalSettings() {
  try {
    await api.put('/smart-rate-limit/global-settings', config.value.globalSettings)
    message.success('ÂÖ®Â±ÄËÆæÁΩÆÂ∑≤Êõ¥Êñ∞')
  } catch (error) {
    console.error('Failed to update global settings:', error)
    message.error('Êõ¥Êñ∞ÂÖ®Â±ÄËÆæÁΩÆÂ§±Ë¥•')
  }
}

async function saveInstantRule() {
  try {
    const keywords = instantRuleForm.value.keywordsText
      .split('\n')
      .map((k) => k.trim())
      .filter((k) => k)

    if (!instantRuleForm.value.name || keywords.length === 0) {
      message.error('ËØ∑Â°´ÂÜôËßÑÂàôÂêçÁß∞ÂíåÂÖ≥ÈîÆËØç')
      return
    }

    const ruleData = {
      name: instantRuleForm.value.name,
      keywords,
      matchMode: instantRuleForm.value.matchMode,
      caseSensitive: instantRuleForm.value.caseSensitive,
      duration: instantRuleForm.value.duration,
      priority: instantRuleForm.value.priority,
      enabled: instantRuleForm.value.enabled
    }

    if (editingRule.value) {
      await api.put(`/smart-rate-limit/rules/instant/${editingRule.value.id}`, ruleData)
      message.success('ËßÑÂàôÂ∑≤Êõ¥Êñ∞')
    } else {
      await api.post('/smart-rate-limit/rules/instant', ruleData)
      message.success('ËßÑÂàôÂ∑≤Ê∑ªÂä†')
    }

    closeInstantRuleDialog()
    await loadConfig()
  } catch (error) {
    console.error('Failed to save instant rule:', error)
    message.error('‰øùÂ≠òËßÑÂàôÂ§±Ë¥•')
  }
}

async function saveCumulativeRule() {
  try {
    const keywords = cumulativeRuleForm.value.keywordsText
      .split('\n')
      .map((k) => k.trim())
      .filter((k) => k)

    if (!cumulativeRuleForm.value.name || keywords.length === 0) {
      message.error('ËØ∑Â°´ÂÜôËßÑÂàôÂêçÁß∞ÂíåÂÖ≥ÈîÆËØç')
      return
    }

    const ruleData = {
      name: cumulativeRuleForm.value.name,
      keywords,
      matchMode: cumulativeRuleForm.value.matchMode,
      caseSensitive: cumulativeRuleForm.value.caseSensitive,
      threshold: cumulativeRuleForm.value.threshold,
      windowSeconds: cumulativeRuleForm.value.windowSeconds,
      duration: cumulativeRuleForm.value.duration,
      priority: cumulativeRuleForm.value.priority,
      enabled: cumulativeRuleForm.value.enabled
    }

    if (editingRule.value) {
      await api.put(`/smart-rate-limit/rules/cumulative/${editingRule.value.id}`, ruleData)
      message.success('ËßÑÂàôÂ∑≤Êõ¥Êñ∞')
    } else {
      await api.post('/smart-rate-limit/rules/cumulative', ruleData)
      message.success('ËßÑÂàôÂ∑≤Ê∑ªÂä†')
    }

    closeCumulativeRuleDialog()
    await loadConfig()
  } catch (error) {
    console.error('Failed to save cumulative rule:', error)
    message.error('‰øùÂ≠òËßÑÂàôÂ§±Ë¥•')
  }
}

async function updateRule(type, rule) {
  try {
    await api.put(`/smart-rate-limit/rules/${type}/${rule.id}`, rule)
  } catch (error) {
    console.error('Failed to update rule:', error)
    message.error('Êõ¥Êñ∞ËßÑÂàôÂ§±Ë¥•')
    await loadConfig()
  }
}

async function deleteRule(type, ruleId) {
  try {
    await api.delete(`/smart-rate-limit/rules/${type}/${ruleId}`)
    message.success('ËßÑÂàôÂ∑≤Âà†Èô§')
    await loadConfig()
  } catch (error) {
    console.error('Failed to delete rule:', error)
    message.error('Âà†Èô§ËßÑÂàôÂ§±Ë¥•')
  }
}

function editRule(type, rule) {
  editingRule.value = rule
  if (type === 'instant') {
    instantRuleForm.value = {
      name: rule.name,
      keywordsText: rule.keywords.join('\n'),
      matchMode: rule.matchMode,
      caseSensitive: rule.caseSensitive,
      duration: rule.duration,
      priority: rule.priority,
      enabled: rule.enabled
    }
    showAddInstantRule.value = true
  } else {
    cumulativeRuleForm.value = {
      name: rule.name,
      keywordsText: rule.keywords.join('\n'),
      matchMode: rule.matchMode,
      caseSensitive: rule.caseSensitive,
      threshold: rule.threshold,
      windowSeconds: rule.windowSeconds,
      duration: rule.duration,
      priority: rule.priority,
      enabled: rule.enabled
    }
    showAddCumulativeRule.value = true
  }
}

async function removeRateLimit(accountId) {
  try {
    await api.delete(`/smart-rate-limit/limited-accounts/${accountId}`)
    message.success('ÈôêÊµÅÂ∑≤Ëß£Èô§')
    await loadLimitedAccounts()
  } catch (error) {
    console.error('Failed to remove rate limit:', error)
    message.error('Ëß£Èô§ÈôêÊµÅÂ§±Ë¥•')
  }
}

async function clearAllRateLimits() {
  try {
    await api.post('/smart-rate-limit/clear-all')
    message.success('ÊâÄÊúâÈôêÊµÅÂ∑≤Ëß£Èô§')
    await loadLimitedAccounts()
  } catch (error) {
    console.error('Failed to clear all rate limits:', error)
    message.error('Ê∏ÖÈô§ÈôêÊµÅÂ§±Ë¥•')
  }
}

async function exportConfig() {
  try {
    const response = await api.get('/smart-rate-limit/export')
    const blob = new Blob([JSON.stringify(response.data, null, 2)], { type: 'application/json' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `smart-rate-limit-config-${Date.now()}.json`
    a.click()
    URL.revokeObjectURL(url)
    message.success('ÈÖçÁΩÆÂ∑≤ÂØºÂá∫')
  } catch (error) {
    console.error('Failed to export config:', error)
    message.error('ÂØºÂá∫ÈÖçÁΩÆÂ§±Ë¥•')
  }
}

async function importConfig() {
  try {
    const configData = JSON.parse(importConfigText.value)
    await api.post('/smart-rate-limit/import', {
      config: configData,
      merge: mergeImport.value
    })
    message.success('ÈÖçÁΩÆÂ∑≤ÂØºÂÖ•')
    showImportDialog.value = false
    importConfigText.value = ''
    await loadConfig()
  } catch (error) {
    console.error('Failed to import config:', error)
    message.error('ÂØºÂÖ•ÈÖçÁΩÆÂ§±Ë¥•Ôºö' + error.message)
  }
}

function refreshLimitedAccounts() {
  loadLimitedAccounts()
  loadStatistics()
}

function closeInstantRuleDialog() {
  showAddInstantRule.value = false
  editingRule.value = null
  instantRuleForm.value = {
    name: '',
    keywordsText: '',
    matchMode: 'contains',
    caseSensitive: false,
    duration: 300,
    priority: 50,
    enabled: true
  }
}

function closeCumulativeRuleDialog() {
  showAddCumulativeRule.value = false
  editingRule.value = null
  cumulativeRuleForm.value = {
    name: '',
    keywordsText: '',
    matchMode: 'contains',
    caseSensitive: false,
    threshold: 3,
    windowSeconds: 300,
    duration: 600,
    priority: 50,
    enabled: true
  }
}

// Â∑•ÂÖ∑ÂáΩÊï∞
function getStatistics(type, ruleId) {
  if (!statistics.value.ruleStatistics) return 0
  const key = `${type}:${ruleId}`
  return statistics.value.ruleStatistics[key]?.triggerCount || 0
}

function formatDate(dateStr) {
  if (!dateStr) return '-'
  const date = new Date(dateStr)
  return date.toLocaleString('zh-CN')
}

function formatRemainingTime(expiresAt) {
  if (!expiresAt) return 'Ê∞∏‰πÖ'

  const now = Date.now()
  const expires = new Date(expiresAt).getTime()
  const remaining = expires - now

  if (remaining <= 0) return 'Â∑≤ËøáÊúü'

  const seconds = Math.floor(remaining / 1000)
  const minutes = Math.floor(seconds / 60)
  const hours = Math.floor(minutes / 60)

  if (hours > 0) {
    return `${hours}Â∞èÊó∂${minutes % 60}ÂàÜÈíü`
  } else if (minutes > 0) {
    return `${minutes}ÂàÜÈíü`
  } else {
    return `${seconds}Áßí`
  }
}

// Ëá™Âä®Âà∑Êñ∞
function startAutoRefresh() {
  refreshTimer.value = setInterval(() => {
    if (activeTab.value === 'limited') {
      loadLimitedAccounts()
    } else if (activeTab.value === 'statistics') {
      loadStatistics()
    }
  }, 5000)
}

function stopAutoRefresh() {
  if (refreshTimer.value) {
    clearInterval(refreshTimer.value)
    refreshTimer.value = null
  }
}

// ÁîüÂëΩÂë®ÊúüÈí©Â≠ê
onMounted(() => {
  loadConfig()
  loadStatistics()
  loadLimitedAccounts()
  startAutoRefresh()
})

onUnmounted(() => {
  stopAutoRefresh()
})
</script>

<style lang="scss" scoped>
.smart-rate-limit-view {
  padding: 24px;

  .page-header {
    margin-bottom: 24px;

    .page-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;

      .icon {
        font-size: 28px;
      }
    }

    .page-description {
      color: var(--n-text-color-3);
      font-size: 14px;
    }
  }

  .settings-card {
    margin-bottom: 24px;
  }

  .tabs-container {
    .tab-content {
      padding: 16px 0;

      .toolbar {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
      }

      .stats-grid {
        margin-bottom: 24px;
      }

      .ranking-card {
        margin-top: 24px;
      }
    }
  }
}
</style>
